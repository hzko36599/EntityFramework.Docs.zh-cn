---
title: 使用 migrate.exe-EF6
description: 使用实体框架6中的 migrate.exe
author: ajcvickers
ms.date: 10/23/2016
uid: ef6/modeling/code-first/migrations/migrate-exe
ms.openlocfilehash: f57f56f7e3fe876c7265526bf6541e3c9e91ca7d
ms.sourcegitcommit: 0a25c03fa65ae6e0e0e3f66bac48d59eceb96a5a
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/14/2020
ms.locfileid: "92066364"
---
# <a name="using-migrateexe"></a><span data-ttu-id="893d8-103">使用 migrate.exe</span><span class="sxs-lookup"><span data-stu-id="893d8-103">Using migrate.exe</span></span>
<span data-ttu-id="893d8-104">Code First 迁移可用于从 visual studio 内部更新数据库，但也可以通过命令行工具 migrate.exe 来执行。</span><span class="sxs-lookup"><span data-stu-id="893d8-104">Code First Migrations can be used to update a database from inside visual studio, but can also be executed via the command line tool migrate.exe.</span></span> <span data-ttu-id="893d8-105">本页将简要介绍如何使用 migrate.exe 来对数据库执行迁移。</span><span class="sxs-lookup"><span data-stu-id="893d8-105">This page will give a quick overview on how to use migrate.exe to execute migrations against a database.</span></span>

> [!NOTE]
> <span data-ttu-id="893d8-106">本文假设你知道如何在基本方案中使用 Code First 迁移。</span><span class="sxs-lookup"><span data-stu-id="893d8-106">This article assumes you know how to use Code First Migrations in basic scenarios.</span></span> <span data-ttu-id="893d8-107">如果没有，则需要先阅读 [Code First 迁移](xref:ef6/modeling/code-first/migrations/index) ，然后再继续。</span><span class="sxs-lookup"><span data-stu-id="893d8-107">If you don’t, then you’ll need to read [Code First Migrations](xref:ef6/modeling/code-first/migrations/index) before continuing.</span></span>

## <a name="copy-migrateexe"></a><span data-ttu-id="893d8-108">复制 migrate.exe</span><span class="sxs-lookup"><span data-stu-id="893d8-108">Copy migrate.exe</span></span>

<span data-ttu-id="893d8-109">使用 NuGet 安装实体框架时 migrate.exe 会位于已下载包的 tools 文件夹内。</span><span class="sxs-lookup"><span data-stu-id="893d8-109">When you install Entity Framework using NuGet migrate.exe will be inside the tools folder of the downloaded package.</span></span> <span data-ttu-id="893d8-110">在 &lt; 项目文件夹 &gt; \\ 包 \\ EntityFramework 中。 &lt;版本 &gt; \\ 工具</span><span class="sxs-lookup"><span data-stu-id="893d8-110">In &lt;project folder&gt;\\packages\\EntityFramework.&lt;version&gt;\\tools</span></span>

<span data-ttu-id="893d8-111">migrate.exe 后，需要将其复制到包含迁移的程序集所在的位置。</span><span class="sxs-lookup"><span data-stu-id="893d8-111">Once you have migrate.exe then you need to copy it to the location of the assembly that contains your migrations.</span></span>

<span data-ttu-id="893d8-112">如果应用程序面向 .NET 4，而不是4.5，则还需要将 **Redirect.config** 复制到该位置，并将其重命名 **migrate.exe.config**。这是为了 migrate.exe 获取正确的绑定重定向，以便能够找到实体框架的程序集。</span><span class="sxs-lookup"><span data-stu-id="893d8-112">If your application targets .NET 4, and not 4.5, then you will need to copy the **Redirect.config** into the location as well and rename it **migrate.exe.config**. This is so that migrate.exe gets the correct binding redirects to be able to locate the Entity Framework assembly.</span></span>

| <span data-ttu-id="893d8-113">.NET 4.5</span><span class="sxs-lookup"><span data-stu-id="893d8-113">.NET 4.5</span></span>                                      | <span data-ttu-id="893d8-114">.NET 4。0</span><span class="sxs-lookup"><span data-stu-id="893d8-114">.NET 4.0</span></span>                                      |
|:----------------------------------------------|:----------------------------------------------|
| ![.NET 4.5 文件](~/ef6/media/net45files.png) | ![.NET 4.0 文件](~/ef6/media/net40files.png) |

> [!NOTE]
> <span data-ttu-id="893d8-117">migrate.exe 不支持 x64 程序集。</span><span class="sxs-lookup"><span data-stu-id="893d8-117">migrate.exe doesn't support x64 assemblies.</span></span>

<span data-ttu-id="893d8-118">将 migrate.exe 移动到正确的文件夹后，应该能够使用它来对数据库执行迁移。</span><span class="sxs-lookup"><span data-stu-id="893d8-118">Once you have moved migrate.exe to the correct folder then you should be able to use it to execute migrations against the database.</span></span> <span data-ttu-id="893d8-119">此实用程序的目的是执行迁移。</span><span class="sxs-lookup"><span data-stu-id="893d8-119">All the utility is designed to do is execute migrations.</span></span> <span data-ttu-id="893d8-120">它无法生成迁移或创建 SQL 脚本。</span><span class="sxs-lookup"><span data-stu-id="893d8-120">It cannot generate migrations or create a SQL script.</span></span>

## <a name="see-options"></a><span data-ttu-id="893d8-121">查看选项</span><span class="sxs-lookup"><span data-stu-id="893d8-121">See options</span></span>

``` console
Migrate.exe /?
```

<span data-ttu-id="893d8-122">以上将显示与此实用程序关联的帮助页，请注意，你需要在运行的同一位置 migrate.exe EntityFramework.dll，才能使其正常运行。</span><span class="sxs-lookup"><span data-stu-id="893d8-122">The above will display the help page associated with this utility, note that you will need to have the EntityFramework.dll in the same location that you are running migrate.exe in order for this to work.</span></span>

## <a name="migrate-to-the-latest-migration"></a><span data-ttu-id="893d8-123">迁移到最新迁移</span><span class="sxs-lookup"><span data-stu-id="893d8-123">Migrate to the latest migration</span></span>

``` console
Migrate.exe MyMvcApplication.dll /startupConfigurationFile="..\\web.config"
```

<span data-ttu-id="893d8-124">在运行时 migrate.exe 唯一的必需参数是程序集，该程序集是包含您尝试运行的迁移的程序集，但如果您未指定配置文件，则它将使用所有基于约定的设置。</span><span class="sxs-lookup"><span data-stu-id="893d8-124">When running migrate.exe the only mandatory parameter is the assembly, which is the assembly that contains the migrations that you are trying to run, but it will use all convention based settings if you do not specify the configuration file.</span></span>

## <a name="migrate-to-a-specific-migration"></a><span data-ttu-id="893d8-125">迁移到特定迁移</span><span class="sxs-lookup"><span data-stu-id="893d8-125">Migrate to a specific migration</span></span>

``` console
Migrate.exe MyApp.exe /startupConfigurationFile="MyApp.exe.config" /targetMigration="AddTitle"
```

<span data-ttu-id="893d8-126">如果要运行到特定迁移的迁移，则可以指定迁移的名称。</span><span class="sxs-lookup"><span data-stu-id="893d8-126">If you want to run migrations up to a specific migration, then you can specify the name of the migration.</span></span> <span data-ttu-id="893d8-127">这会根据需要运行所有以前的迁移，直到获取所指定的迁移。</span><span class="sxs-lookup"><span data-stu-id="893d8-127">This will run all previous migrations as required until getting to the migration specified.</span></span>

## <a name="specify-working-directory"></a><span data-ttu-id="893d8-128">指定工作目录</span><span class="sxs-lookup"><span data-stu-id="893d8-128">Specify working directory</span></span>

``` console
Migrate.exe MyApp.exe /startupConfigurationFile="MyApp.exe.config" /startupDirectory="c:\\MyApp"
```

<span data-ttu-id="893d8-129">如果程序集具有依赖项或读取相对于工作目录的文件，则需要设置 startupDirectory。</span><span class="sxs-lookup"><span data-stu-id="893d8-129">If you assembly has dependencies or reads files relative to the working directory then you will need to set startupDirectory.</span></span>

## <a name="specify-migration-configuration-to-use"></a><span data-ttu-id="893d8-130">指定要使用的迁移配置</span><span class="sxs-lookup"><span data-stu-id="893d8-130">Specify migration configuration to use</span></span>

``` console
Migrate.exe MyAssembly CustomConfig /startupConfigurationFile="..\\web.config"
```

<span data-ttu-id="893d8-131">如果有多个迁移配置类，继承自 DbMigrationConfiguration 的类，则需要指定将用于此执行的类。</span><span class="sxs-lookup"><span data-stu-id="893d8-131">If you have multiple migration configuration classes, classes inheriting from DbMigrationConfiguration, then you need to specify which is to be used for this execution.</span></span> <span data-ttu-id="893d8-132">这是通过提供可选的第二个参数（不带上述开关）来指定的。</span><span class="sxs-lookup"><span data-stu-id="893d8-132">This is specified by providing the optional second parameter without a switch as above.</span></span>

## <a name="provide-connection-string"></a><span data-ttu-id="893d8-133">提供连接字符串</span><span class="sxs-lookup"><span data-stu-id="893d8-133">Provide connection string</span></span>

``` console
Migrate.exe BlogDemo.dll /connectionString="Data Source=localhost;Initial Catalog=BlogDemo;Integrated Security=SSPI" /connectionProviderName="System.Data.SqlClient"
```

<span data-ttu-id="893d8-134">如果要在命令行中指定连接字符串，则还必须提供提供程序名称。</span><span class="sxs-lookup"><span data-stu-id="893d8-134">If you wish to specify a connection string at the command line then you must also provide the provider name.</span></span> <span data-ttu-id="893d8-135">如果未指定提供程序名称，将导致异常。</span><span class="sxs-lookup"><span data-stu-id="893d8-135">Not specifying the provider name will cause an exception.</span></span>

## <a name="common-problems"></a><span data-ttu-id="893d8-136">常见问题</span><span class="sxs-lookup"><span data-stu-id="893d8-136">Common Problems</span></span>

| <span data-ttu-id="893d8-137">错误消息</span><span class="sxs-lookup"><span data-stu-id="893d8-137">Error Message</span></span>                                                                                                                                                                                                                                                                                                                      | <span data-ttu-id="893d8-138">解决方案</span><span class="sxs-lookup"><span data-stu-id="893d8-138">Solution</span></span>                                                                                                                                                                                                                                                                                             |
|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| <span data-ttu-id="893d8-139">未经处理的异常： FileLoadException：无法加载文件或程序集 "EntityFramework，Version = 5.0.0.0，Culture = 中立，PublicKeyToken = b77a5c561934e089" 或其依赖项之一。</span><span class="sxs-lookup"><span data-stu-id="893d8-139">Unhandled Exception: System.IO.FileLoadException:  Could not load file or assembly 'EntityFramework, Version=5.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089' or one of its dependencies.</span></span> <span data-ttu-id="893d8-140">找到的程序集清单定义与程序集引用不匹配。</span><span class="sxs-lookup"><span data-stu-id="893d8-140">The located assembly's manifest definition does not match the assembly reference.</span></span> <span data-ttu-id="893d8-141"> (HRESULT 中的异常： 0x80131040) </span><span class="sxs-lookup"><span data-stu-id="893d8-141">(Exception from HRESULT: 0x80131040)</span></span>         | <span data-ttu-id="893d8-142">这通常意味着你在运行不带 Redirect.config 文件的 .NET 4 应用程序。</span><span class="sxs-lookup"><span data-stu-id="893d8-142">This typically means that you are running a .NET 4 application without the Redirect.config file.</span></span> <span data-ttu-id="893d8-143">需要将 Redirect.config 复制到 migrate.exe 的同一位置，并将其重命名为 migrate.exe.config。</span><span class="sxs-lookup"><span data-stu-id="893d8-143">You need to copy the Redirect.config to the same location as migrate.exe and rename it to migrate.exe.config.</span></span>                                                                                       |
| <span data-ttu-id="893d8-144">未经处理的异常： FileLoadException：无法加载文件或程序集 "EntityFramework，Version = 4.4.0.0，Culture = 中立，PublicKeyToken = b77a5c561934e089" 或其依赖项之一。</span><span class="sxs-lookup"><span data-stu-id="893d8-144">Unhandled Exception: System.IO.FileLoadException: Could not load file or assembly 'EntityFramework, Version=4.4.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089' or one of its dependencies.</span></span> <span data-ttu-id="893d8-145">找到的程序集清单定义与程序集引用不匹配。</span><span class="sxs-lookup"><span data-stu-id="893d8-145">The located assembly's manifest definition does not match the assembly reference.</span></span> <span data-ttu-id="893d8-146"> (HRESULT 中的异常： 0x80131040) </span><span class="sxs-lookup"><span data-stu-id="893d8-146">(Exception from HRESULT: 0x80131040)</span></span>          | <span data-ttu-id="893d8-147">此异常表示你运行的 .NET 4.5 应用程序 Redirect.config 复制到 migrate.exe 位置。</span><span class="sxs-lookup"><span data-stu-id="893d8-147">This exception means that you are running a .NET 4.5 application with the Redirect.config copied to the migrate.exe location.</span></span> <span data-ttu-id="893d8-148">如果应用是 .NET 4.5，则不需要在内部重定向配置文件。</span><span class="sxs-lookup"><span data-stu-id="893d8-148">If your app is .NET 4.5 then you do not need to have the config file with the redirects inside.</span></span> <span data-ttu-id="893d8-149">删除 migrate.exe.config 文件。</span><span class="sxs-lookup"><span data-stu-id="893d8-149">Delete the migrate.exe.config file.</span></span>                                    |
| <span data-ttu-id="893d8-150">错误：无法更新数据库以匹配当前模型，因为存在挂起的更改，并且禁用了自动迁移。</span><span class="sxs-lookup"><span data-stu-id="893d8-150">ERROR: Unable to update database to match the current model because there are pending changes and automatic migration is disabled.</span></span> <span data-ttu-id="893d8-151">将挂起的模型更改写入到基于代码的迁移或启用自动迁移。</span><span class="sxs-lookup"><span data-stu-id="893d8-151">Either write the pending model changes to a code-based migration or enable automatic migration.</span></span> <span data-ttu-id="893d8-152">将 DbMigrationsConfiguration 设置为 true 以启用自动迁移。</span><span class="sxs-lookup"><span data-stu-id="893d8-152">Set DbMigrationsConfiguration.AutomaticMigrationsEnabled to true to enable automatic migration.</span></span> | <span data-ttu-id="893d8-153">如果尚未创建迁移来处理对模型所做的更改，并且数据库与模型不匹配，则会发生此错误。</span><span class="sxs-lookup"><span data-stu-id="893d8-153">This error occurs if running migrate when you haven’t created a migration to cope with changes made to the model, and the database does not match the model.</span></span> <span data-ttu-id="893d8-154">将属性添加到模型类后，运行 migrate.exe 而不创建迁移来升级数据库就是这样的示例。</span><span class="sxs-lookup"><span data-stu-id="893d8-154">Adding a property to a model class then running migrate.exe without creating a migration to upgrade the database is an example of this.</span></span> |
| <span data-ttu-id="893d8-155">错误：未解析成员 "ToolingFacade + UpdateRunner，EntityFramework，Version = 5.0.0.0，Culture = 中立，PublicKeyToken = b77a5c561934e089" 的类型。</span><span class="sxs-lookup"><span data-stu-id="893d8-155">ERROR: Type is not resolved for member 'System.Data.Entity.Migrations.Design.ToolingFacade+UpdateRunner,EntityFramework, Version=5.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089'.</span></span>                                                                                                                                       | <span data-ttu-id="893d8-156">此错误的原因可能是指定了错误的启动目录。</span><span class="sxs-lookup"><span data-stu-id="893d8-156">This error can be caused by specifying an incorrect startup directory.</span></span> <span data-ttu-id="893d8-157">这必须是 migrate.exe 的位置</span><span class="sxs-lookup"><span data-stu-id="893d8-157">This must be the location of migrate.exe</span></span>                                                                                                                                                                                      |
| <span data-ttu-id="893d8-158">未经处理的异常： NullReferenceException：对象引用未设置为对象的实例。</span><span class="sxs-lookup"><span data-stu-id="893d8-158">Unhandled Exception: System.NullReferenceException: Object reference not set to an instance of an object.</span></span> <br/>   <span data-ttu-id="893d8-159">在 System.web. Main (String [] 参数上为) </span><span class="sxs-lookup"><span data-stu-id="893d8-159">at System.Data.Entity.Migrations.Console.Program.Main(String[] args)</span></span>                                                                                                                                             | <span data-ttu-id="893d8-160">这可能是由于未为你使用的方案指定必需参数引起的。</span><span class="sxs-lookup"><span data-stu-id="893d8-160">This can be caused by not specifying a required parameter for a scenario that you are using.</span></span> <span data-ttu-id="893d8-161">例如，在不指定提供程序名称的情况下指定连接字符串。</span><span class="sxs-lookup"><span data-stu-id="893d8-161">For example specifying a connection string without specifying the provider name.</span></span>                                                                                                                        |
| <span data-ttu-id="893d8-162">错误：在程序集 "Classlibrary1.chainone" 中找到了多个迁移配置类型。</span><span class="sxs-lookup"><span data-stu-id="893d8-162">ERROR: More than one migrations configuration type was found in the assembly 'ClassLibrary1'.</span></span> <span data-ttu-id="893d8-163">指定要使用的名称。</span><span class="sxs-lookup"><span data-stu-id="893d8-163">Specify the name of the one to use.</span></span>                                                                                                                                                                                                  | <span data-ttu-id="893d8-164">作为错误状态，在给定的程序集中有多个配置类。</span><span class="sxs-lookup"><span data-stu-id="893d8-164">As the error states, there is more than one configuration class in the given assembly.</span></span> <span data-ttu-id="893d8-165">必须使用/configurationType 开关来指定要使用的。</span><span class="sxs-lookup"><span data-stu-id="893d8-165">You must use the /configurationType switch to specify which to use.</span></span>                                                                                                                                           |
| <span data-ttu-id="893d8-166">错误：无法加载文件或程序集 " &lt; assemblyName &gt; " 或其依赖项之一。</span><span class="sxs-lookup"><span data-stu-id="893d8-166">ERROR: Could not load file or assembly ‘&lt;assemblyName&gt;’ or one of its dependencies.</span></span> <span data-ttu-id="893d8-167">给定的程序集名称或基本代码无效。</span><span class="sxs-lookup"><span data-stu-id="893d8-167">The given assembly name or codebase was invalid.</span></span> <span data-ttu-id="893d8-168"> (HRESULT 中的异常： 0x80131047) </span><span class="sxs-lookup"><span data-stu-id="893d8-168">(Exception from HRESULT: 0x80131047)</span></span>                                                                                                                                                    | <span data-ttu-id="893d8-169">这可能是由于不正确地指定程序集名称或</span><span class="sxs-lookup"><span data-stu-id="893d8-169">This can be caused by specifying an assembly name incorrectly or not having</span></span>                                                                                                                                                                                                                          |
| <span data-ttu-id="893d8-170">错误：无法加载文件或程序集 " &lt; assemblyName &gt; " 或其依赖项之一。</span><span class="sxs-lookup"><span data-stu-id="893d8-170">ERROR: Could not load file or assembly ‘&lt;assemblyName&gt;' or one of its dependencies.</span></span> <span data-ttu-id="893d8-171">试图加载的程序的格式不正确。</span><span class="sxs-lookup"><span data-stu-id="893d8-171">An attempt was made to load a program with an incorrect format.</span></span>                                                                                                                                                                          | <span data-ttu-id="893d8-172">如果尝试对 x64 应用程序运行 migrate.exe，则会发生这种情况。</span><span class="sxs-lookup"><span data-stu-id="893d8-172">This happens if you are trying to run migrate.exe against an x64 application.</span></span> <span data-ttu-id="893d8-173">EF 5.0 和更低的将仅适用于 x86。</span><span class="sxs-lookup"><span data-stu-id="893d8-173">EF 5.0 and below will only work on x86.</span></span>                                                                                                                                                                                |
